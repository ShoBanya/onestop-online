# リモートワーク（テレワーク）における環境について

私は現在、社内SEをしているのですが、社内でVPN環境を準備していたところ、サプライチェーンの崩壊により思わぬリスクが露見しました。
そう。ドングル方式のVPNクライアントを採用していたのでクライアント数が増やせない。

orz.....

さあ、どうしようとなったところで、弊社は急遽別のVPNソフトも併用する方針に舵を切ることになったのでした。
（リモートの準備してなくて業務が止まるよりはさすがにマシかな・・・と。）

## リモートワーク(VPN)におけるソフトについて

ここに関しては色々と比較検討をしたのですが、以下４点の理由からSoftether社のDesktopVPNを利用する事にしました。

・社内的な心理的抵抗感が少なそう [^1]

・私が個人的に同社の製品(PacketiX VPN)を使った事があった

・新型コロナウイルス感染防止のためテレワーク用 Desktop VPN 無償開放を実施していた
　(現在６月末まで ※執筆時点での2020/5/5現在) [^2] [^3]

・リモート接続用のソフトウェアとして枯れていた

[^1]: 筑波大学の学内ベンチャーで国内資本の会社でもあるので…というと話が通りやすかったんですよね。心理的抵抗感を下げるのはこういうケースでは大事だと思いました。

[^2]: https://www.softether.jp/7-news/2020.02.21

[^3]: https://www.softether.jp/7-news/2020.03.24

### DesktopVPNの会社的な導入手順

この項移行は、DesktopVPNを導入する…という前提で検討した内容や実際にハマったポイントなどを記載します。
なお、勝手に会社のPCにこのソフトを入れても下手するとリモートワークできてしまうのですが、システム管理者に確認をとり（あわよくば巻き込んで）リモートワークを進めて頂く事をお勧めしておきます。

#### 導入検証し、サーバソフトのセキュリティ方式を決める

まずは試験用環境を１台～数台選定し、まず導入して検証してみましょう。

なお、サーバソフト、クライアントソフトは
https://www.desktopvpn.net/download/
からダウンロードできます。

またこの手のソフトで一番重要ともいえる、接続においての認証方式は、様々な方式が選べるようになっています。

・(このアプリで設定した独自の)パスワードでの認証方式

・(このアプリで設定した独自の)ユーザIDとパスワードでの認証方式

・匿名認証方式

・Radius認証方式

・Windowsドメイン認証方式

・証明書認証方式(※電子証明書もオレオレで良ければ自前発行できるみたい…)

※なおセキュリティ設定の「高度なユーザー認証機能の設定」の中にオレオレ電子証明書出力機能がいたりします。
![“証明書出力機能“](chap-remote-work_env/oreore.png?scale=0.7)
電子証明書をクライアント側のPCに渡して設定させるのがハードル高いですけどね・・・。（笑）

どの運用で行くかは予め決めておき、パスワード認証を用いるのであれば長めのランダムパスワードも必要分生成しておきましょう。（ユーザリストが予め決まっているのであれば、IDとユーザパスワードなどもセットで準備しておいてしまうのが後々楽です。）

また、サーバー設定ツールにもパスワードロックを掛ける事ができます。
情シス的な運用で、管理をちゃんとやる前提であれば、パスワードも決めて掛けておきましょう。

#### 会社の(リモート接続先の)PCにサーバソフトを入れる

https://www.desktopvpn.net/download/

から

・Desktop VPN共有機能有効版(Ver 2.70 Build 8600)

・Desktop VPN共有機能無効版(Ver 2.70 Build 8600)

のどちらかを導入しましょう。
なお弊社の場合は穴をあけても管理観点からは嬉しい要素が全くなかったので一括で無効版にしました。

なおソフトウェア導入の際にパスワード設定も求められるようになっています。
各ユーザのリモート接続先PCをセットアップしていく段では、流れでパスワードやセキュリティ設定も併せて設定してしまいましょう。

また、サーバを設定したときに表示される

・コンピュータID

をメモしておきましょう。
![“コンピュータID表示例“](chap-remote-work_env/compid.png?scale=0.7)

#### 会社の(リモート接続先の)PCに接続しに行くPCにクライアントソフトを入れる

https://www.desktopvpn.net/download/

から
・Desktop VPN 実行ファイル形式クライアント(Ver 2.70 Build 8600)
を導入しましょう。

そして、前項のコンピュータIDと、予め設定した認証要素を用い、リモート接続してみましょう。

#### 詰まった点

・この手のリモート接続ツールは、各種セキュリティ対策ソフトが悪さをする事が往々にあります。各種セキュリティ対策ソフトと干渉した場合、"C:\Program Files (x86)\Desktop VPN Server\DeskServer.exe"　がリモートサーバのソフトウェア本体なので、このアプリケーションを各種セキュリティ対策ソフトの監視対象外に設定する事で状況が改善する事があります。(実際に改善しました。)

・内部的にはWindowsのRemoteDesktopサービスを使ってるのですが、このサービスが上がってないとダメです。プロパティからスタートアップの種類を「自動」に変更しておきましょう。
![“リモートデスクトップサービス“](chap-remote-work_env/RemoteDesktop.png?scale=0.7)
![“設定例“](chap-remote-work_env/RemoteDesktop2.png?scale=0.7)

・Windowsの電源設定も見直しておきましょう。1日経ったら繋がらなくなった（PCの電源切れてた）とかはだいたいこれが悪さをしていることが多いです。
入り方はコントロールパネルから。

電源オプションを選択し
![“電源設定の入り方1“](chap-remote-work_env/PowerSetting1.png?scale=0.7)
プラン設定の変更から
![“電源設定の入り方2“](chap-remote-work_env/PowerSetting2.png?scale=0.7)
詳細な電源設定の変更に入っておきましょう。
![“電源設定の入り方3“](chap-remote-work_env/PowerSetting3.png?scale=0.7)

具体的な電源設定ですが、まず時間経過によるスリープ、休止を全て止めましょう。ハイブリッドスリープもしなくて良いですね・・・
![“電源設定1“](chap-remote-work_env/PowerSetting4.png?scale=0.7)
スリープ解除タイマーはあまり影響無い気がするのでお好きに・・・
![“電源設定2“](chap-remote-work_env/PowerSetting5.png?scale=0.7)
USBのディレクティブサスペンドに関しては、USB経由でリモート接続している（USBのNIC使ってるとかレアケースの）場合は無効のほうがいいケースはあります。
![“電源設定3“](chap-remote-work_env/PowerSetting6.png?scale=0.7)
ノートの場合はカバー閉じてスリープになったりするのもあるあるなので閉じた時の動作も何もしないにしておくほうが幸せな気がします。
スリープボタンも動作しないようにしておきましょう。
![“電源設定4“](chap-remote-work_env/PowerSetting7.png?scale=0.7)
リモートしてる時ってディスプレイも普通は要らないはずなので、電源Offのほうが地球にもやさしいですね。
![“電源設定5“](chap-remote-work_env/PowerSetting8.png?scale=0.7)

弊社で電源周りが怪しいな・・・と踏んだ時の電源設定はこんな感じです。

### 実際に運用してみてわかった点

・実時間で１７時から２２時ぐらいまではインターネットが全般的に重くなるようで、プロバイダによっては通信が切れるという報告が１０％程度の利用者からありました。

・実際に家で使った際、おそらくルーターがダメなんだと思いますがWifiだと操作のラグがひどく、タイピングが辛かったのですが有線LAN接続に変えたところ非常にラグが減り、安定しました。

・WindowsUpdateに巻き込まれるとPCが再起動したり、品質の悪いパッチが入って不安定になったりして辛いですね。WSUSが欲しくなる・・・（本来WSUSってそういうのを期待して入れるものではない気はするんだけど。）

・DesktopVPNはそれだけで集中監視できるわけではないので、そういうのが要るのであれば別のソフト使ったほうが良い気がする。（なんかサーバ立てる系の・・・）

とりあえず弊社では１００人超のユーザーをDesktopVPNで捌いてますが、とりあえずちゃんと動いてリモートワークが実現できてはいる（実際に出社は７割以上減ってる）ので、これぐらいの規模であればちゃんと準備して運用すれば耐えられるな・・・という知見が得られました。

色々と雑多に書きましたが、あなたのリモートワークの参考になれば幸いです。
